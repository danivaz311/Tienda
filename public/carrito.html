<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Carrito de Compras</title>
</head>
<body>
  <h1>üõí Carrito de Compras</h1>
  <div id="carrito"></div>
  <h3 id="total"></h3>

  <button onclick="vaciarCarrito()">üßπ Vaciar carrito</button>
  <button onclick="window.location.href='index.html'">‚¨ÖÔ∏è Volver a la tienda</button>
  <button onclick="finalizarCompra()">üßæ Finalizar compra</button>

  <script>
    function mostrarCarrito() {
      const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
      const contenedor = document.getElementById('carrito');
      const totalSpan = document.getElementById('total');
      contenedor.innerHTML = '';

      if (carrito.length === 0) {
        contenedor.innerHTML = '<p>Tu carrito est√° vac√≠o.</p>';
        totalSpan.textContent = '';
        return;
      }

      let total = 0;

      carrito.forEach((item, index) => {
        total += item.precio * item.cantidad;

        const div = document.createElement('div');
        div.innerHTML = `
          <strong>${item.titulo}</strong><br>
          Precio: $${item.precio} x ${item.cantidad} = $${(item.precio * item.cantidad).toFixed(2)}<br>
          <button onclick="cambiarCantidad(${index}, 1)">‚ûï</button>
          <button onclick="cambiarCantidad(${index}, -1)">‚ûñ</button>
          <button onclick="eliminarLibro(${index})">‚ùå Eliminar</button>
          <hr>
        `;
        contenedor.appendChild(div);
      });

      totalSpan.textContent = `Total: $${total.toFixed(2)}`;
    }

    function cambiarCantidad(index, delta) {
      const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
      carrito[index].cantidad += delta;

      if (carrito[index].cantidad <= 0) {
        carrito.splice(index, 1);
      }

      localStorage.setItem('carrito', JSON.stringify(carrito));
      mostrarCarrito();
    }

    function eliminarLibro(index) {
      const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
      carrito.splice(index, 1);
      localStorage.setItem('carrito', JSON.stringify(carrito));
      mostrarCarrito();
    }

    function vaciarCarrito() {
      if (confirm('¬øEst√°s seguro de que deseas vaciar el carrito?')) {
        localStorage.removeItem('carrito');
        mostrarCarrito();
      }
    }
async function finalizarCompra() {
  const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
  const token = localStorage.getItem('token');

  if (!token) {
    alert('Debes iniciar sesi√≥n para realizar la compra.');
    return;
  }

  if (carrito.length === 0) {
    alert('El carrito est√° vac√≠o.');
    return;
  }

  try {

const response = await fetch('/api/orden', {



      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ carrito })
    });

    if (response.ok) {
      alert('‚úÖ ¬°Compra realizada con √©xito!');
      const orden = await response.json(); // supongamos que el backend te devuelve el id y fecha

  localStorage.removeItem('carrito');

  // Guarda detalles para mostrar en la confirmaci√≥n
  localStorage.setItem('ordenConfirmada', JSON.stringify(orden));

  // Redirige a la p√°gina de confirmaci√≥n
  window.location.href = 'orden-confirmada.html';
    }else{
      const err = await response.json();
      alert('‚ùå Error: ' + err.error);
    }
  } catch (error) {
    console.error('Error al finalizar la compra:', error);
    alert('‚ùå Error al realizar la compra.');
  }
}
    mostrarCarrito();
  </script>
</body>
</html>
